<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Available Properties - User View</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #f8fafc;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    h1 {
      color: #0ea5e9;
      margin-bottom: 10px;
    }
    .subtitle {
      color: #64748b;
      margin-bottom: 30px;
    }
    .user-prefs {
      background: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .user-prefs h2 {
      font-size: 18px;
      color: #334155;
      margin-bottom: 15px;
    }
    .pref-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }
    .pref-item {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .pref-label {
      font-size: 14px;
      color: #64748b;
    }
    .pref-value {
      font-weight: 600;
      color: #0ea5e9;
    }
    .filters {
      background: white;
      padding: 15px 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }
    .filters button {
      padding: 10px 20px;
      border: 2px solid #e2e8f0;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }
    .filters button.active {
      background: #0ea5e9;
      color: white;
      border-color: #0ea5e9;
    }
    .property-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
    }
    .property-card {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: transform 0.2s, box-shadow 0.2s;
      cursor: pointer;
    }
    .property-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }
    .property-card.match {
      border: 3px solid #22c55e;
    }
    .property-card.unavailable {
      opacity: 0.6 !important;
      background: #f1f5f9 !important;
      pointer-events: auto;
    }
    .property-card.unavailable:hover {
      transform: none !important;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
    }
    .property-card.unavailable .property-image {
      filter: grayscale(100%) !important;
      opacity: 0.5;
    }
    .property-card.unavailable .property-title,
    .property-card.unavailable .property-price {
      color: #94a3b8 !important;
    }
    .unavailable-badge {
      display: inline-block;
      background: #fee2e2;
      color: #ef4444;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
      margin-bottom: 10px;
    }
    .property-image {
      height: 200px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 48px;
    }
    .property-body {
      padding: 20px;
    }
    .property-title {
      font-size: 18px;
      font-weight: 700;
      color: #334155;
      margin-bottom: 10px;
    }
    .property-address {
      font-size: 14px;
      color: #64748b;
      margin-bottom: 15px;
    }
    .property-price {
      font-size: 24px;
      font-weight: 700;
      color: #0ea5e9;
      margin-bottom: 10px;
    }
    .property-details {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      font-size: 14px;
      color: #64748b;
    }
    .match-badge {
      display: inline-block;
      background: #dcfce7;
      color: #22c55e;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
      margin-bottom: 10px;
    }
    .payment-info {
      background: #f1f5f9;
      padding: 12px;
      border-radius: 8px;
      font-size: 13px;
      color: #475569;
    }
    .payment-info strong {
      color: #334155;
    }
    .no-results {
      text-align: center;
      padding: 60px 20px;
      color: #64748b;
    }
    .form-section {
      background: white;
      padding: 25px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .form-section h2 {
      font-size: 20px;
      color: #334155;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .form-group label {
      font-size: 14px;
      font-weight: 600;
      color: #475569;
    }
    .form-group input, .form-group select, .form-group textarea {
      padding: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      transition: border-color 0.2s;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none;
      border-color: #0ea5e9;
    }
    .form-group textarea {
      min-height: 80px;
      resize: vertical;
    }
    .btn-save {
      padding: 12px 30px;
      background: linear-gradient(135deg, #0ea5e9, #22c55e);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(14,165,233,0.3);
      transition: all 0.2s;
    }
    .btn-save:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(14,165,233,0.4);
    }
    
    /* Calendar Modal Styles */
    .calendar-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .calendar-modal.active {
      display: flex;
    }
    .calendar-modal-content {
      background: white;
      border-radius: 16px;
      padding: 30px;
      max-width: 900px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      position: relative;
    }
    .modal-close {
      position: absolute;
      top: 15px;
      right: 15px;
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 50%;
      width: 35px;
      height: 35px;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      margin-top: 20px;
    }
    .calendar-day {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid #e2e8f0;
      border-radius: 4px;
      font-size: 13px;
      position: relative;
    }
    .calendar-day.header {
      font-weight: 700;
      background: #f1f5f9;
      color: #475569;
    }
    .calendar-day.booked {
      background: #fee2e2;
      color: #991b1b;
      font-weight: 700;
    }
    .calendar-day.available {
      background: #dcfce7;
      color: #166534;
    }
    .calendar-day.today {
      border: 2px solid #0ea5e9;
    }
  </style>
</head>
<body>
  <div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <div>
        <h1 style="margin-bottom: 5px;">üèòÔ∏è Available Properties - User View</h1>
        <p class="subtitle" style="margin-bottom: 0;">Set your preferences and browse properties</p>
      </div>
      <div style="display: flex; gap: 10px;">
        <button onclick="window.location.href='../../a_landing_page/index.html'" style="padding: 10px 20px; background: #0ea5e9; color: white; border: none; border-radius: 8px; cursor: pointer;">‚Üê Back to Home</button>
      </div>
    </div>

    <!-- Contact Information Form -->
    <div class="form-section">
      <h2>üìß Contact Information</h2>
      <p style="color: #64748b; margin-bottom: 20px; font-size: 14px;">Enter your contact details to receive property inquiry replies</p>
      <div class="form-grid">
        <div class="form-group">
          <label>Full Name *</label>
          <input type="text" id="userName" placeholder="John Smith" required>
        </div>
        <div class="form-group">
          <label>Email Address *</label>
          <input type="email" id="userEmail" placeholder="john@example.com" required>
        </div>
        <div class="form-group">
          <label>Phone Number</label>
          <input type="tel" id="userPhone" placeholder="+1 (555) 123-4567">
        </div>
      </div>
    </div>

    <!-- User Preferences Form -->
    <div class="form-section">
      <h2>üéØ Your Preferences</h2>
      <p style="color: #64748b; margin-bottom: 20px; font-size: 14px;">Set your property preferences to find the best matches</p>
      <div class="form-grid">
        <div class="form-group">
          <label>Check-in Date</label>
          <input type="date" id="checkInDate" min="2025-12-01">
        </div>
        <div class="form-group">
          <label>Check-out Date</label>
          <input type="date" id="checkOutDate" min="2025-12-01">
        </div>
        <div class="form-group">
          <label>Max Daily Budget ($)</label>
          <input type="number" id="maxBudget" placeholder="250" min="50" step="10">
        </div>
        <div class="form-group">
          <label>Minimum Bedrooms</label>
          <select id="minBedrooms">
            <option value="">Any</option>
            <option value="1">1+</option>
            <option value="2" selected>2+</option>
            <option value="3">3+</option>
            <option value="4">4+</option>
          </select>
        </div>
        <div class="form-group">
          <label>Preferred Region</label>
          <select id="regionPref">
            <option value="">Any</option>
            <option value="North Atlanta">North Atlanta</option>
            <option value="South Atlanta">South Atlanta</option>
            <option value="East Atlanta">East Atlanta</option>
            <option value="West Atlanta">West Atlanta</option>
          </select>
        </div>
        <div class="form-group">
          <label>Stay Intent</label>
          <select id="intentPref">
            <option value="vacation">Vacation</option>
            <option value="business">Business</option>
            <option value="relocation">Relocation</option>
            <option value="investment">Investment</option>
          </select>
        </div>
      </div>
      <div class="form-group" style="grid-column: 1 / -1;">
        <label>Additional Notes / Special Requests</label>
        <textarea id="userNotes" placeholder="Any specific requirements or preferences..."></textarea>
      </div>
      <div style="margin-top: 20px;">
        <button class="btn-save" onclick="saveUserPreferences()">üíæ Save Preferences</button>
        <span id="saveStatus" style="margin-left: 15px; color: #22c55e; font-weight: 600;"></span>
      </div>
    </div>

    <!-- Current Preferences Display -->
    <div class="user-prefs" id="userPrefs" style="display: none;">
      <h2>üìã Current Saved Preferences</h2>
      <div class="pref-grid">
        <div class="pref-item">
          <span class="pref-label">Budget:</span>
          <span class="pref-value" id="budgetDisplay">Loading...</span>
        </div>
        <div class="pref-item">
          <span class="pref-label">Dates:</span>
          <span class="pref-value" id="datesDisplay">Loading...</span>
        </div>
        <div class="pref-item">
          <span class="pref-label">Region:</span>
          <span class="pref-value" id="regionDisplay">Loading...</span>
        </div>
        <div class="pref-item">
          <span class="pref-label">Intent:</span>
          <span class="pref-value" id="intentDisplay">Loading...</span>
        </div>
      </div>
    </div>

    <div class="filters">
      <strong>Filter:</strong>
      <button class="active" onclick="filterProperties('all')">All Properties</button>
      <button onclick="filterProperties('matches')">Best Matches</button>
      <button onclick="filterProperties('budget')">Within Budget</button>
      <button onclick="filterProperties('cashflow')">Positive Cashflow</button>
      <div id="availabilityStats" style="margin-left: auto; padding: 10px 20px; background: linear-gradient(135deg, #22c55e, #0ea5e9); color: white; border-radius: 8px; font-weight: 700; font-size: 14px;">
        Loading...
      </div>
    </div>

    <div class="property-grid" id="propertyGrid">
      <p class="no-results">Loading properties...</p>
    </div>
  </div>

  <!-- Calendar Modal -->
  <div class="calendar-modal" id="calendarModal" onclick="if(event.target === this) closeCalendarModal()">
    <div class="calendar-modal-content">
      <button class="modal-close" onclick="closeCalendarModal()">√ó</button>
      <h2 style="color: #0ea5e9; margin-bottom: 10px;">üìÖ Property Availability</h2>
      <h3 id="modalPropertyTitle" style="color: #64748b; font-size: 16px; font-weight: 400; margin-bottom: 20px;"></h3>
      <div style="display: flex; gap: 20px; margin-bottom: 20px; font-size: 13px;">
        <div style="display: flex; align-items: center; gap: 8px;">
          <div style="width: 20px; height: 20px; background: #dcfce7; border: 1px solid #22c55e; border-radius: 3px;"></div>
          <span>Available</span>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <div style="width: 20px; height: 20px; background: #fee2e2; border: 1px solid #ef4444; border-radius: 3px;"></div>
          <span>Booked</span>
        </div>
      </div>
      <div id="calendarContainer"></div>
    </div>
  </div>

  <script>
    let properties = [];
    let userData = null;
    let currentFilter = 'all';

    async function loadData() {
      try {
        // Load properties
        const propResponse = await fetch('../a_data/links_info.json');
        const propData = await propResponse.json();
        properties = propData.properties;

        // Initialize with some demo bookings if none exist
        const existingBookings = localStorage.getItem('adminBookings');
        if (!existingBookings) {
          const demoBookings = [
            {
              id: 1,
              name: "John Doe",
              email: "john@example.com",
              propertyAddress: properties[0]?.address || "Sample Property 1",
              startDate: "2025-12-06",
              endDate: "2025-12-10",
              pricePerNight: 150,
              totalNights: 4,
              totalCost: 600,
              status: "confirmed"
            },
            {
              id: 2,
              name: "Jane Smith",
              email: "jane@example.com",
              propertyAddress: properties[1]?.address || "Sample Property 2",
              startDate: "2025-12-08",
              endDate: "2025-12-15",
              pricePerNight: 200,
              totalNights: 7,
              totalCost: 1400,
              status: "confirmed"
            },
            {
              id: 3,
              name: "Bob Wilson",
              email: "bob@example.com",
              propertyAddress: properties[2]?.address || "Sample Property 3",
              startDate: "2025-12-11",
              endDate: "2025-12-14",
              pricePerNight: 175,
              totalNights: 3,
              totalCost: 525,
              status: "confirmed"
            }
          ];
          localStorage.setItem('adminBookings', JSON.stringify(demoBookings));
        }

        // Load user data from localStorage
        const savedUser = localStorage.getItem('vividOasisUserData');
        if (savedUser) {
          userData = JSON.parse(savedUser);
          populateFormFields();
          displayUserPreferences();
          document.getElementById('userPrefs').style.display = 'block';
        }

        displayProperties('all');

      } catch (error) {
        console.error('Error loading data:', error);
        document.getElementById('propertyGrid').innerHTML = '<p class="no-results">Error loading properties</p>';
      }
    }

    function populateFormFields() {
      if (!userData || !userData.user) return;
      
      const user = userData.user;
      const prefs = user.preferences;
      
      // Populate contact info
      if (user.name) document.getElementById('userName').value = user.name;
      if (user.email) document.getElementById('userEmail').value = user.email;
      if (user.phone) document.getElementById('userPhone').value = user.phone;
      
      // Populate preferences
      if (prefs.dates.checkIn) document.getElementById('checkInDate').value = prefs.dates.checkIn;
      if (prefs.dates.checkOut) document.getElementById('checkOutDate').value = prefs.dates.checkOut;
      if (prefs.budget.maxDailySpend) document.getElementById('maxBudget').value = prefs.budget.maxDailySpend;
      if (prefs.propertyPreferences.minBedrooms) document.getElementById('minBedrooms').value = prefs.propertyPreferences.minBedrooms;
      if (prefs.propertyPreferences.region) document.getElementById('regionPref').value = prefs.propertyPreferences.region;
      if (prefs.propertyPreferences.intent) document.getElementById('intentPref').value = prefs.propertyPreferences.intent;
      if (user.notes) document.getElementById('userNotes').value = user.notes;
    }

    function saveUserPreferences() {
      // Get form values
      const name = document.getElementById('userName').value.trim();
      const email = document.getElementById('userEmail').value.trim();
      const phone = document.getElementById('userPhone').value.trim();
      
      const checkIn = document.getElementById('checkInDate').value;
      const checkOut = document.getElementById('checkOutDate').value;
      const budget = parseFloat(document.getElementById('maxBudget').value) || 0;
      const bedrooms = parseInt(document.getElementById('minBedrooms').value) || 2;
      const region = document.getElementById('regionPref').value;
      const intent = document.getElementById('intentPref').value;
      const notes = document.getElementById('userNotes').value.trim();
      
      // Validation
      if (!name || !email) {
        alert('‚ö†Ô∏è Please enter your name and email address');
        return;
      }
      
      if (!email.includes('@')) {
        alert('‚ö†Ô∏è Please enter a valid email address');
        return;
      }
      
      // Calculate nights
      let totalNights = 0;
      if (checkIn && checkOut) {
        const start = new Date(checkIn);
        const end = new Date(checkOut);
        totalNights = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
        
        if (totalNights <= 0) {
          alert('‚ö†Ô∏è Check-out date must be after check-in date');
          return;
        }
      }
      
      // Create user data object
      const userDataObj = {
        user: {
          id: Date.now(),
          name: name,
          email: email,
          phone: phone,
          notes: notes,
          preferences: {
            dates: {
              checkIn: checkIn || '',
              checkOut: checkOut || '',
              totalNights: totalNights
            },
            budget: {
              maxDailySpend: budget,
              totalBudget: budget * totalNights
            },
            propertyPreferences: {
              minBedrooms: bedrooms,
              region: region,
              intent: intent,
              amenities: []
            }
          },
          savedAt: new Date().toISOString()
        }
      };
      
      // Save to localStorage
      localStorage.setItem('vividOasisUserData', JSON.stringify(userDataObj));
      userData = userDataObj;
      
      // Show success message
      const status = document.getElementById('saveStatus');
      status.textContent = '‚úÖ Preferences saved successfully!';
      setTimeout(() => {
        status.textContent = '';
      }, 3000);
      
      // Update display
      displayUserPreferences();
      document.getElementById('userPrefs').style.display = 'block';
      
      // Refresh property display
      displayProperties(currentFilter);
      
      // Scroll to properties
      setTimeout(() => {
        document.querySelector('.filters').scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 500);
    }

    function displayUserPreferences() {
      if (!userData || !userData.user) {
        document.getElementById('userPrefs').style.display = 'none';
        return;
      }

      const prefs = userData.user.preferences;
      
      document.getElementById('budgetDisplay').textContent = 
        `$${prefs.budget.maxDailySpend}/day (Total: $${prefs.budget.totalBudget})`;
      
      document.getElementById('datesDisplay').textContent = 
        `${prefs.dates.checkIn || 'Not set'} to ${prefs.dates.checkOut || 'Not set'} (${prefs.dates.totalNights || 0} nights)`;
      
      document.getElementById('regionDisplay').textContent = 
        prefs.propertyPreferences.region || 'Not specified';
      
      document.getElementById('intentDisplay').textContent = 
        prefs.propertyPreferences.intent || 'Not specified';
    }

    function filterProperties(filter) {
      currentFilter = filter;
      
      // Update active button
      document.querySelectorAll('.filters button').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      
      displayProperties(filter);
    }

    function displayProperties(filter) {
      const grid = document.getElementById('propertyGrid');
      
      if (!properties || properties.length === 0) {
        grid.innerHTML = '<p class="no-results">No properties available</p>';
        return;
      }

      let filteredProps = [...properties];

      // Apply additional filters but DON'T filter by availability - show all properties
      if (filter === 'matches' && userData && userData.user) {
        // Filter by user budget estimate (very rough)
        const estimatedBudget = userData.user.preferences.budget.maxDailySpend * 365 * 10; // 10 years
        filteredProps = filteredProps.filter(p => p.totalPrice <= estimatedBudget);
      } else if (filter === 'budget' && userData && userData.user) {
        const estimatedBudget = userData.user.preferences.budget.maxDailySpend * 365 * 10;
        filteredProps = filteredProps.filter(p => p.totalPrice <= estimatedBudget);
      } else if (filter === 'cashflow') {
        filteredProps = filteredProps.filter(p => p.monthlyRent >= p.estimatedMonthlyPayment);
      }

      if (filteredProps.length === 0) {
        grid.innerHTML = '<p class="no-results">No properties match your criteria</p>';
        return;
      }

      grid.innerHTML = '';

      filteredProps.forEach(property => {
        // Get nightly rate from admin settings (localStorage)
        const adminRates = JSON.parse(localStorage.getItem('propertyNightlyRates') || '{}');
        const nightlyRate = adminRates[property.address] || Math.round(property.monthlyRent / 30);
        
        const userBudget = userData && userData.user ? userData.user.preferences.budget.maxDailySpend : 0;
        const isAffordable = nightlyRate <= userBudget;
        const totalNights = userData && userData.user ? userData.user.preferences.dates.totalNights : 1;
        const totalStayCost = nightlyRate * totalNights;
        
        // Check availability for user's dates
        let isAvailable = true;
        let checkIn = '';
        let checkOut = '';
        if (userData && userData.user && userData.user.preferences && userData.user.preferences.dates) {
          checkIn = userData.user.preferences.dates.checkIn;
          checkOut = userData.user.preferences.dates.checkOut;
          if (checkIn && checkOut) {
            const availability = checkAvailability(property.address, checkIn, checkOut);
            isAvailable = availability.available;
          }
        }
        
        const card = document.createElement('div');
        card.className = `property-card ${isAffordable ? 'match' : ''} ${!isAvailable ? 'unavailable' : ''}`;
        
        // Debug: Add title attribute to show availability status
        card.title = `Available: ${isAvailable}, Check-in: ${checkIn}, Check-out: ${checkOut}`;
        
        card.innerHTML = `
          <div class="property-image">üè¢</div>
          <div class="property-body">
            ${!isAvailable ? '<span class="unavailable-badge">üîí Booked for your dates</span>' : ''}
            ${isAffordable && userBudget > 0 && isAvailable ? '<span class="match-badge">‚ú® Within Budget</span>' : ''}
            <h3 class="property-title">${property.address.split(',')[0]}</h3>
            <p class="property-address">${property.address.split(',').slice(1).join(',').trim()}</p>
            <div class="property-price">$${nightlyRate}/night</div>
            <div class="property-details">
              <span>üõèÔ∏è ${property.bedrooms} bed</span>
              <span>üõÅ ${property.bathrooms} bath</span>
              <span>üìê ${property.sqft} sqft</span>
            </div>
            ${totalNights > 0 ? `
              <div class="payment-info">
                <div><strong>${totalNights} nights:</strong> $${totalStayCost.toLocaleString()}</div>
                ${userBudget > 0 && isAvailable ? `
                  <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e2e8f0;">
                    ${isAffordable 
                      ? `‚úÖ <strong>Affordable!</strong> $${userBudget - nightlyRate}/night under budget`
                      : `‚ö†Ô∏è $${nightlyRate - userBudget}/night over budget`
                    }
                  </div>
                ` : ''}
              </div>
            ` : ''}
            ${!isAvailable ? `
              <button style="width: 100%; margin-top: 12px; padding: 10px; background: linear-gradient(135deg, #f59e0b, #ef4444); color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer;" onclick="event.stopPropagation(); viewPropertyCalendar('${property.address.replace(/'/g, "\\'")}')">
                üìÖ View Availability Calendar
              </button>
            ` : ''}
            ${isAvailable && userData && userData.user && userData.user.name && userData.user.email && userData.user.preferences && userData.user.preferences.dates && userData.user.preferences.dates.checkIn && userData.user.preferences.dates.checkOut ? `
              <button style="width: 100%; margin-top: 12px; padding: 10px; background: linear-gradient(135deg, #22c55e, #10b981); color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer;" onclick="event.stopPropagation(); submitBooking('${property.address}', ${nightlyRate})">
                üìÖ Request Booking
              </button>
            ` : ''}
            <button style="width: 100%; margin-top: 8px; padding: 10px; background: linear-gradient(135deg, #0ea5e9, #06b6d4); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;" onclick="event.stopPropagation(); window.open('${property.link}', '_blank')">
              View Details ‚Üí
            </button>
          </div>
        `;
        
        grid.appendChild(card);
      });
      
      // Update availability statistics
      updateAvailabilityStats(filteredProps);
    }
    
    // Update availability statistics display
    function updateAvailabilityStats(propertiesToCheck) {
      const statsDiv = document.getElementById('availabilityStats');
      
      if (!userData || !userData.user || !userData.user.preferences || !userData.user.preferences.dates) {
        statsDiv.innerHTML = 'üìä Set dates to see availability';
        statsDiv.style.background = '#94a3b8';
        return;
      }
      
      const checkIn = userData.user.preferences.dates.checkIn;
      const checkOut = userData.user.preferences.dates.checkOut;
      
      if (!checkIn || !checkOut) {
        statsDiv.innerHTML = 'üìä Set dates to see availability';
        statsDiv.style.background = '#94a3b8';
        return;
      }
      
      let availableCount = 0;
      let bookedCount = 0;
      
      propertiesToCheck.forEach(property => {
        const availability = checkAvailability(property.address, checkIn, checkOut);
        if (availability.available) {
          availableCount++;
        } else {
          bookedCount++;
        }
      });
      
      const total = availableCount + bookedCount;
      statsDiv.innerHTML = `‚úÖ ${availableCount} / ${total} Available`;
      
      if (availableCount === total) {
        statsDiv.style.background = 'linear-gradient(135deg, #22c55e, #10b981)';
      } else if (availableCount === 0) {
        statsDiv.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
      } else {
        statsDiv.style.background = 'linear-gradient(135deg, #f59e0b, #0ea5e9)';
      }
    }
    
    // Check if dates are available for booking
    function checkAvailability(propertyAddress, checkInDate, checkOutDate) {
      const existingBookings = JSON.parse(localStorage.getItem('adminBookings') || '[]');
      const requestStart = new Date(checkInDate);
      const requestEnd = new Date(checkOutDate);
      
      // Check for overlaps with existing bookings for THIS SPECIFIC PROPERTY
      for (let booking of existingBookings) {
        // Only check bookings for the same property
        if (booking.propertyAddress !== propertyAddress) {
          continue; // Skip bookings for different properties
        }
        
        const bookingStart = new Date(booking.startDate);
        const bookingEnd = new Date(booking.endDate);
        
        // Check if dates overlap
        if (requestStart <= bookingEnd && requestEnd >= bookingStart) {
          return {
            available: false,
            conflictingBooking: booking
          };
        }
      }
      
      return { available: true };
    }
    
    // Submit a booking request
    function submitBooking(propertyAddress, nightlyRate) {
      if (!userData || !userData.user) {
        alert('Please fill out your contact information and preferences first.');
        window.scrollTo({ top: 0, behavior: 'smooth' });
        return;
      }
      
      const user = userData.user;
      const checkIn = user.preferences.dates.checkIn;
      const checkOut = user.preferences.dates.checkOut;
      
      if (!checkIn || !checkOut) {
        alert('Please set your check-in and check-out dates in the preferences form above.');
        window.scrollTo({ top: 0, behavior: 'smooth' });
        return;
      }
      
      // Check availability
      const availability = checkAvailability(propertyAddress, checkIn, checkOut);
      
      if (!availability.available) {
        const conflict = availability.conflictingBooking;
        alert(`Sorry, this property is not available for your dates.\n\nConflicting booking:\n${conflict.name}\n${conflict.startDate} to ${conflict.endDate}\n\nPlease choose different dates or another property.`);
        return;
      }
      
      // Create booking
      const totalNights = Math.ceil((new Date(checkOut) - new Date(checkIn)) / (1000 * 60 * 60 * 24));
      const totalCost = nightlyRate * totalNights;
      
      const newBooking = {
        id: Date.now(),
        name: user.name,
        email: user.email,
        phone: user.phone || '',
        propertyAddress: propertyAddress,
        startDate: checkIn,
        endDate: checkOut,
        pricePerNight: nightlyRate,
        totalNights: totalNights,
        totalCost: totalCost,
        status: 'pending',
        submittedAt: new Date().toISOString()
      };
      
      // Save to localStorage
      const existingBookings = JSON.parse(localStorage.getItem('adminBookings') || '[]');
      existingBookings.push(newBooking);
      localStorage.setItem('adminBookings', JSON.stringify(existingBookings));
      
      // Show confirmation
      alert(`‚úÖ Booking Request Submitted!\n\nProperty: ${propertyAddress}\nGuest: ${user.name}\nDates: ${checkIn} to ${checkOut}\nNights: ${totalNights}\nTotal: $${totalCost.toLocaleString()}\n\nWe'll contact you at ${user.email} to confirm your booking.`);
      
      // Optional: refresh the display
      displayProperties(currentFilter);
    }
    
    // View property availability calendar
    function viewPropertyCalendar(propertyAddress) {
      const modal = document.getElementById('calendarModal');
      const modalTitle = document.getElementById('modalPropertyTitle');
      const calendarContainer = document.getElementById('calendarContainer');
      
      modalTitle.textContent = propertyAddress;
      
      // Get all bookings for this property
      const existingBookings = JSON.parse(localStorage.getItem('adminBookings') || '[]');
      const propertyBookings = existingBookings.filter(b => b.propertyAddress === propertyAddress);
      
      // Generate calendar for next 3 months
      const today = new Date();
      let calendarHTML = '';
      
      for (let monthOffset = 0; monthOffset < 3; monthOffset++) {
        const currentDate = new Date(today.getFullYear(), today.getMonth() + monthOffset, 1);
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const monthName = currentDate.toLocaleString('default', { month: 'long', year: 'numeric' });
        
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        calendarHTML += `
          <div style="margin-bottom: 30px;">
            <h3 style="color: #334155; margin-bottom: 15px;">${monthName}</h3>
            <div class="calendar-grid">
              <div class="calendar-day header">Sun</div>
              <div class="calendar-day header">Mon</div>
              <div class="calendar-day header">Tue</div>
              <div class="calendar-day header">Wed</div>
              <div class="calendar-day header">Thu</div>
              <div class="calendar-day header">Fri</div>
              <div class="calendar-day header">Sat</div>
        `;
        
        // Empty cells for days before month starts
        for (let i = 0; i < firstDay; i++) {
          calendarHTML += '<div class="calendar-day"></div>';
        }
        
        // Days of the month
        for (let day = 1; day <= daysInMonth; day++) {
          const cellDate = new Date(year, month, day);
          const dateStr = cellDate.toISOString().split('T')[0];
          
          // Check if this day is booked
          let isBooked = false;
          for (let booking of propertyBookings) {
            const bookingStart = new Date(booking.startDate);
            const bookingEnd = new Date(booking.endDate);
            if (cellDate >= bookingStart && cellDate <= bookingEnd) {
              isBooked = true;
              break;
            }
          }
          
          // Check if today
          const isToday = cellDate.toDateString() === new Date().toDateString();
          
          const className = `calendar-day ${isBooked ? 'booked' : 'available'} ${isToday ? 'today' : ''}`;
          calendarHTML += `<div class="${className}">${day}</div>`;
        }
        
        calendarHTML += '</div></div>';
      }
      
      calendarContainer.innerHTML = calendarHTML;
      modal.classList.add('active');
    }
    
    function closeCalendarModal() {
      document.getElementById('calendarModal').classList.remove('active');
    }

    // Load data on page load
    loadData();
  </script>
</body>
</html>
